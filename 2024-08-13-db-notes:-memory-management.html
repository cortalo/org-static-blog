<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="This is a personal note for the [[https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf][CMU 15-445 L6 notes]]"
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>CMU 15-445 notes: Memory Management</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="assets/style.css" type="text/css" />
    <link rel="favicon" type="image/x-icon" href="assets/favicon.ico" />
    <script src="assets/search.js"></script>
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="archive.html">Archive</a>
          <a href="tags.html">Tags</a>
          <div id="search-container">
            <input
              type="text"
              id="search-input"
              placeholder="Search anywhere..."
            />
          </div>
        </nav>
      </header>
    </div>
    <div id="content">
      <div class="post-date">13 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-13-db-notes:-memory-management.html"
          >CMU 15-445 notes: Memory Management</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org878eac8">1. Goals</a></li>
            <li>
              <a href="#orgae344d8">2. Locks &amp; Latches</a>
              <ul>
                <li><a href="#orgb42efab">2.1. Locks</a></li>
                <li><a href="#orgd9fd27c">2.2. Latches</a></li>
              </ul>
            </li>
            <li>
              <a href="#org298a910">3. Buffer pool</a>
              <ul>
                <li><a href="#org2d90453">3.1. Metadata</a></li>
                <li>
                  <a href="#orgb63f3f7">3.2. Memory allocation policies</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#org3805579">4. Buffer pool optimizations</a>
              <ul>
                <li><a href="#org9b43666">4.1. Multiple buffer pools</a></li>
                <li><a href="#org13e62f9">4.2. Pre-fetching</a></li>
                <li><a href="#orgdf3f7fb">4.3. Scan sharing</a></li>
                <li><a href="#org8a553b9">4.4. Buffer pool bypass</a></li>
              </ul>
            </li>
            <li>
              <a href="#org3bb9063">5. Buffer replacement policies</a>
              <ul>
                <li>
                  <a href="#org5442e67">5.1. Least recently used (LRU)</a>
                </li>
                <li><a href="#org2d21f4d">5.2. Clock</a></li>
                <li>
                  <a href="#org8589567">5.3. LRU-K</a>
                  <ul>
                    <li>
                      <a href="#org60fb0f6">5.3.1. MySQL approximate LRU-K</a>
                    </li>
                  </ul>
                </li>
                <li><a href="#org8442957">5.4. Localization</a></li>
                <li><a href="#orgeb7a1fd">5.5. Priority hint</a></li>
                <li><a href="#org50e6724">5.6. Dirty pages</a></li>
              </ul>
            </li>
            <li><a href="#org44ca5e9">6. Other memory pools</a></li>
            <li><a href="#org21effca">7. OS cache bypass</a></li>
            <li><a href="#org3b99925">8. I/O scheduling</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf"
          >CMU 15-445 L6 notes</a
        >
        as well as some explanation from Claude.ai.
      </p>
      <div id="outline-container-org878eac8" class="outline-2">
        <h2 id="org878eac8"><span class="section-number-2">1.</span> Goals</h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Manage DBMS memory and move data between the memory and the disk,
              such that the execution engine does no worry about the data
              fetching.
            </li>
            <li>
              Spatial control: keep relevant pages physically together on disk.
            </li>
            <li>
              Temporal control: minimize the number of stalls to read data from
              the disk.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgae344d8" class="outline-2">
        <h2 id="orgae344d8">
          <span class="section-number-2">2.</span> Locks &amp; Latches
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Both used to protect internal elements.</li>
          </ul>
        </div>
        <div id="outline-container-orgb42efab" class="outline-3">
          <h3 id="orgb42efab">
            <span class="section-number-3">2.1.</span> Locks
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                A high-level logical primitive to allow for transaction
                atomicity.
              </li>
              <li>Exposed to users when queries are run.</li>
              <li>Need to be able to rollback changes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd9fd27c" class="outline-3">
          <h3 id="orgd9fd27c">
            <span class="section-number-3">2.2.</span> Latches
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                A low-level protection primitive a DBMS uses in its internal
                data structures, e.g., hash tables.
              </li>
              <li>Only held when the operation is being made, like a mutex.</li>
              <li>
                Do not need to expose to users or used to rollback changes.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org298a910" class="outline-2">
        <h2 id="org298a910">
          <span class="section-number-2">3.</span> Buffer pool
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>An in-memory cache of pages read from the disk.</li>
            <li>
              The buffer pool&rsquo;s region of memory is organized as an array
              of fixed size pages; each array entry is called a frame.
            </li>
            <li>
              When the DBMS requests a page, the buffer pool first searches its
              cache, if not found, it copies he page from the disk into one of
              its frame.
            </li>
            <li>
              Dirty pages (i.e., modified pages) are buffered rather than
              writing back immediately.
            </li>
          </ul>
        </div>
        <div id="outline-container-org2d90453" class="outline-3">
          <h3 id="org2d90453">
            <span class="section-number-3">3.1.</span> Metadata
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                Page table: An in-memory hash mapping page ids to frame
                locations in the buffer pool.
              </li>
              <li>
                Dirty flag: set by a thread whenever it modifies a page to
                indicate the pages must be written back to disk.
              </li>
              <li>
                Pin/Reference counter: tracks the number of threads that are
                currently accessing the page; the storage manager is not allowed
                to evict a page if its pin count is greater than 0.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb63f3f7" class="outline-3">
          <h3 id="orgb63f3f7">
            <span class="section-number-3">3.2.</span> Memory allocation
            policies
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <ul class="org-ul">
              <li>
                The buffer pool decides when to allocate a frame for a page.
              </li>
              <li>
                Global policies: decisions based on the overall workload, e.g.,
                least recently used (LRU) or clock algorithm.
              </li>
              <li>
                Local policies: decisions applying to specific query, e.g.,
                priority-based page replacement.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3805579" class="outline-2">
        <h2 id="org3805579">
          <span class="section-number-2">4.</span> Buffer pool optimizations
        </h2>
        <div class="outline-text-2" id="text-4"></div>
        <div id="outline-container-org9b43666" class="outline-3">
          <h3 id="org9b43666">
            <span class="section-number-3">4.1.</span> Multiple buffer pools
          </h3>
          <div class="outline-text-3" id="text-4-1">
            <ul class="org-ul">
              <li>
                Each database or page can have its own buffer pool and adopts
                local policies to reduce latch contention.
              </li>
              <li>
                To map a page to a buffer pool, the DBMS can use object IDs or
                page IDs as the key.
                <ul class="org-ul">
                  <li>
                    Record ID: a unique identifier for a row in a table (cf.
                    <a
                      href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org2317270"
                      >Tuple layout post</a
                    >).
                  </li>
                  <li>
                    Object ID: a unique identifier for an object, used to
                    reference a user-defined type.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org13e62f9" class="outline-3">
          <h3 id="org13e62f9">
            <span class="section-number-3">4.2.</span> Pre-fetching
          </h3>
          <div class="outline-text-3" id="text-4-2">
            <ul class="org-ul">
              <li>
                While the first set of pages is being processed, the DBMS can
                pre-fetch the second set into the buffer pool based on the
                dependency between pages.
                <ul class="org-ul">
                  <li>
                    E.g., If pages are index-organized, the sibling pages can be
                    pre-fetched.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgdf3f7fb" class="outline-3">
          <h3 id="orgdf3f7fb">
            <span class="section-number-3">4.3.</span> Scan sharing
          </h3>
          <div class="outline-text-3" id="text-4-3">
            <ul class="org-ul">
              <li>Query cursors can reuse retrieved data.</li>
              <li>
                When a query comes while a previous query is being processed by
                scanning the table, the new query can attach its scanning cursor
                to the first query&rsquo;s cursor.
              </li>
              <li>
                The DBMS keeps track of where the second query joined to make
                sure it also completes the scan.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8a553b9" class="outline-3">
          <h3 id="org8a553b9">
            <span class="section-number-3">4.4.</span> Buffer pool bypass
          </h3>
          <div class="outline-text-3" id="text-4-4">
            <ul class="org-ul">
              <li>
                Scanned pages do not have to be stored in the buffer pool to
                avoid the overhead.
              </li>
              <li>
                Use cases: a query needs to read a large sequence of contiguous
                pages; temporary pages like sorting or joins.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3bb9063" class="outline-2">
        <h2 id="org3bb9063">
          <span class="section-number-2">5.</span> Buffer replacement policies
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              The DBMS decides which page to evict from the buffer pool to free
              up a frame.
            </li>
          </ul>
        </div>
        <div id="outline-container-org5442e67" class="outline-3">
          <h3 id="org5442e67">
            <span class="section-number-3">5.1.</span> Least recently used (LRU)
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                LRU maintains a timestamp of when each page was last accessed,
                and evicts the page with the oldest timestamp.
                <ul class="org-ul">
                  <li>
                    The timestamp can be stored in a queue for efficient
                    sorting.
                  </li>
                </ul>
              </li>
              <li>
                Susceptible to sequential flooding, where the buffer pool is
                corrupted due to a sequential scan.
                <ul class="org-ul">
                  <li>
                    With the LRU policy the oldest pages are evicted, but they
                    are more likely to be scanned soon.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2d21f4d" class="outline-3">
          <h3 id="org2d21f4d">
            <span class="section-number-3">5.2.</span> Clock
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>
                An approximation of LRU but replace the timestamp with a
                reference bit which is set to 1 when a page is accessed.
              </li>
              <li>
                Regularly sweeping all pages, if a bit is set to 1, reset to 0;
                if a bit is 0, evict the page.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8589567" class="outline-3">
          <h3 id="org8589567">
            <span class="section-number-3">5.3.</span> LRU-K
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Tracks the last K accessed timestamps to predict the next
                accessed time, hence avoid the sequential flooding issue.
              </li>
            </ul>
          </div>
          <div id="outline-container-org60fb0f6" class="outline-4">
            <h4 id="org60fb0f6">
              <span class="section-number-4">5.3.1.</span> MySQL approximate
              LRU-K
            </h4>
            <div class="outline-text-4" id="text-5-3-1">
              <ul class="org-ul">
                <li>
                  Use a linked list with two entry points: &ldquo;old&rdquo; and
                  &ldquo;young&rdquo;.
                </li>
                <li>
                  The new pages are always inserted to the head of
                  &ldquo;old&rdquo;.
                </li>
                <li>
                  If a page in the &ldquo;old&rdquo; is accessed again, it is
                  then inserted to the head of &ldquo;young&rdquo;.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org8442957" class="outline-3">
          <h3 id="org8442957">
            <span class="section-number-3">5.4.</span> Localization
          </h3>
          <div class="outline-text-3" id="text-5-4">
            <ul class="org-ul">
              <li>
                Instead of using a global replacement policy, the DBMS make
                eviction decisions based on each query.
              </li>
              <li>
                Pages brought in by one query are less likely to evict pages
                that are important for other ongoing queries.
              </li>
              <li>
                The DBMS can <b><b>predicts</b></b> more accurately which pages
                should stay or be evicted once the query is complete, so that
                the buffer pool is less polluted with less useful pages.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgeb7a1fd" class="outline-3">
          <h3 id="orgeb7a1fd">
            <span class="section-number-3">5.5.</span> Priority hint
          </h3>
          <div class="outline-text-3" id="text-5-5">
            <ul class="org-ul">
              <li>
                Transactions tell the buffer pool where pages are important
                based on the <b><b>context</b></b> of each page.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org50e6724" class="outline-3">
          <h3 id="org50e6724">
            <span class="section-number-3">5.6.</span> Dirty pages
          </h3>
          <div class="outline-text-3" id="text-5-6">
            <ul class="org-ul">
              <li>
                Two ways to handle dirty pages in the buffer pool:
                <ul class="org-ul">
                  <li>Fast: only drop clean pages.</li>
                  <li>
                    Slow: write back dirty pages to ensure persistent change,
                    and then evict them (if they will not be read again.).
                  </li>
                </ul>
              </li>
              <li>
                Can periodically walk through the page table and write back
                dirty pages in the background.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org44ca5e9" class="outline-2">
        <h2 id="org44ca5e9">
          <span class="section-number-2">6.</span> Other memory pools
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>
              A DBMS also maintains other pools to store:
              <ul class="org-ul">
                <li>query caches,</li>
                <li>logs,</li>
                <li>temporary tables, e.g., sorting, join,</li>
                <li>dictionary caches.</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org21effca" class="outline-2">
        <h2 id="org21effca">
          <span class="section-number-2">7.</span> OS cache bypass
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              Most DBMS use direct I/O (e.g., with <code>fsync</code> instead of
              <code>fwrite</code>) to bypass the OS cache to avoid redundant
              page copy and to manage eviction policies more intelligently (cf.
              <a
                href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org611ff38"
                >Why not OS post</a
              >).
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org3b99925" class="outline-2">
        <h2 id="org3b99925">
          <span class="section-number-2">8.</span> I/O scheduling
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              The DBMS maintains internal <b><b>queue</b></b> to track page
              read/write.
            </li>
            <li>
              The priority are determined by multi-facets, e.g., critical path
              task, SLAs.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <div id="search-results"></div>
      <footer>
        <p>Â© 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
