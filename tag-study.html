<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>org-static-blog</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="assets/style.css" type="text/css" />
    <link rel="favicon" type="image/x-icon" href="assets/favicon.ico" />
    <script src="assets/search.js"></script>
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="archive.html">Archive</a>
          <a href="tags.html">Tags</a>
          <div id="search-container">
            <input
              type="text"
              id="search-input"
              placeholder="Search anywhere..."
            />
          </div>
        </nav>
      </header>
    </div>
    <div id="content">
      <h1 class="title">Posts tagged "study":</h1>
      <div class="post-date">13 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-13-db-notes:-memory-management.html"
          >CMU 15-445 notes: Memory Management</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org878eac8">1. Goals</a></li>
            <li>
              <a href="#orgae344d8">2. Locks &amp; Latches</a>
              <ul>
                <li><a href="#orgb42efab">2.1. Locks</a></li>
                <li><a href="#orgd9fd27c">2.2. Latches</a></li>
              </ul>
            </li>
            <li>
              <a href="#org298a910">3. Buffer pool</a>
              <ul>
                <li><a href="#org2d90453">3.1. Metadata</a></li>
                <li>
                  <a href="#orgb63f3f7">3.2. Memory allocation policies</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#org3805579">4. Buffer pool optimizations</a>
              <ul>
                <li><a href="#org9b43666">4.1. Multiple buffer pools</a></li>
                <li><a href="#org13e62f9">4.2. Pre-fetching</a></li>
                <li><a href="#orgdf3f7fb">4.3. Scan sharing</a></li>
                <li><a href="#org8a553b9">4.4. Buffer pool bypass</a></li>
              </ul>
            </li>
            <li>
              <a href="#org3bb9063">5. Buffer replacement policies</a>
              <ul>
                <li>
                  <a href="#org5442e67">5.1. Least recently used (LRU)</a>
                </li>
                <li><a href="#org2d21f4d">5.2. Clock</a></li>
                <li>
                  <a href="#org8589567">5.3. LRU-K</a>
                  <ul>
                    <li>
                      <a href="#org60fb0f6">5.3.1. MySQL approximate LRU-K</a>
                    </li>
                  </ul>
                </li>
                <li><a href="#org8442957">5.4. Localization</a></li>
                <li><a href="#orgeb7a1fd">5.5. Priority hint</a></li>
                <li><a href="#org50e6724">5.6. Dirty pages</a></li>
              </ul>
            </li>
            <li><a href="#org44ca5e9">6. Other memory pools</a></li>
            <li><a href="#org21effca">7. OS cache bypass</a></li>
            <li><a href="#org3b99925">8. I/O scheduling</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf"
          >CMU 15-445 L6 notes</a
        >
        as well as some explanation from Claude.ai.
      </p>
      <div id="outline-container-org878eac8" class="outline-2">
        <h2 id="org878eac8"><span class="section-number-2">1.</span> Goals</h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Manage DBMS memory and move data between the memory and the disk,
              such that the execution engine does no worry about the data
              fetching.
            </li>
            <li>
              Spatial control: keep relevant pages physically together on disk.
            </li>
            <li>
              Temporal control: minimize the number of stalls to read data from
              the disk.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgae344d8" class="outline-2">
        <h2 id="orgae344d8">
          <span class="section-number-2">2.</span> Locks &amp; Latches
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Both used to protect internal elements.</li>
          </ul>
        </div>
        <div id="outline-container-orgb42efab" class="outline-3">
          <h3 id="orgb42efab">
            <span class="section-number-3">2.1.</span> Locks
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                A high-level logical primitive to allow for transaction
                atomicity.
              </li>
              <li>Exposed to users when queries are run.</li>
              <li>Need to be able to rollback changes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd9fd27c" class="outline-3">
          <h3 id="orgd9fd27c">
            <span class="section-number-3">2.2.</span> Latches
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                A low-level protection primitive a DBMS uses in its internal
                data structures, e.g., hash tables.
              </li>
              <li>Only held when the operation is being made, like a mutex.</li>
              <li>
                Do not need to expose to users or used to rollback changes.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org298a910" class="outline-2">
        <h2 id="org298a910">
          <span class="section-number-2">3.</span> Buffer pool
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>An in-memory cache of pages read from the disk.</li>
            <li>
              The buffer pool&rsquo;s region of memory is organized as an array
              of fixed size pages; each array entry is called a frame.
            </li>
            <li>
              When the DBMS requests a page, the buffer pool first searches its
              cache, if not found, it copies he page from the disk into one of
              its frame.
            </li>
            <li>
              Dirty pages (i.e., modified pages) are buffered rather than
              writing back immediately.
            </li>
          </ul>
        </div>
        <div id="outline-container-org2d90453" class="outline-3">
          <h3 id="org2d90453">
            <span class="section-number-3">3.1.</span> Metadata
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                Page table: An in-memory hash mapping page ids to frame
                locations in the buffer pool.
              </li>
              <li>
                Dirty flag: set by a thread whenever it modifies a page to
                indicate the pages must be written back to disk.
              </li>
              <li>
                Pin/Reference counter: tracks the number of threads that are
                currently accessing the page; the storage manager is not allowed
                to evict a page if its pin count is greater than 0.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb63f3f7" class="outline-3">
          <h3 id="orgb63f3f7">
            <span class="section-number-3">3.2.</span> Memory allocation
            policies
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <ul class="org-ul">
              <li>
                The buffer pool decides when to allocate a frame for a page.
              </li>
              <li>
                Global policies: decisions based on the overall workload, e.g.,
                least recently used (LRU) or clock algorithm.
              </li>
              <li>
                Local policies: decisions applying to specific query, e.g.,
                priority-based page replacement.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3805579" class="outline-2">
        <h2 id="org3805579">
          <span class="section-number-2">4.</span> Buffer pool optimizations
        </h2>
        <div class="outline-text-2" id="text-4"></div>
        <div id="outline-container-org9b43666" class="outline-3">
          <h3 id="org9b43666">
            <span class="section-number-3">4.1.</span> Multiple buffer pools
          </h3>
          <div class="outline-text-3" id="text-4-1">
            <ul class="org-ul">
              <li>
                Each database or page can have its own buffer pool and adopts
                local policies to reduce latch contention.
              </li>
              <li>
                To map a page to a buffer pool, the DBMS can use object IDs or
                page IDs as the key.
                <ul class="org-ul">
                  <li>
                    Record ID: a unique identifier for a row in a table (cf.
                    <a
                      href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org2317270"
                      >Tuple layout post</a
                    >).
                  </li>
                  <li>
                    Object ID: a unique identifier for an object, used to
                    reference a user-defined type.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org13e62f9" class="outline-3">
          <h3 id="org13e62f9">
            <span class="section-number-3">4.2.</span> Pre-fetching
          </h3>
          <div class="outline-text-3" id="text-4-2">
            <ul class="org-ul">
              <li>
                While the first set of pages is being processed, the DBMS can
                pre-fetch the second set into the buffer pool based on the
                dependency between pages.
                <ul class="org-ul">
                  <li>
                    E.g., If pages are index-organized, the sibling pages can be
                    pre-fetched.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgdf3f7fb" class="outline-3">
          <h3 id="orgdf3f7fb">
            <span class="section-number-3">4.3.</span> Scan sharing
          </h3>
          <div class="outline-text-3" id="text-4-3">
            <ul class="org-ul">
              <li>Query cursors can reuse retrieved data.</li>
              <li>
                When a query comes while a previous query is being processed by
                scanning the table, the new query can attach its scanning cursor
                to the first query&rsquo;s cursor.
              </li>
              <li>
                The DBMS keeps track of where the second query joined to make
                sure it also completes the scan.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8a553b9" class="outline-3">
          <h3 id="org8a553b9">
            <span class="section-number-3">4.4.</span> Buffer pool bypass
          </h3>
          <div class="outline-text-3" id="text-4-4">
            <ul class="org-ul">
              <li>
                Scanned pages do not have to be stored in the buffer pool to
                avoid the overhead.
              </li>
              <li>
                Use cases: a query needs to read a large sequence of contiguous
                pages; temporary pages like sorting or joins.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3bb9063" class="outline-2">
        <h2 id="org3bb9063">
          <span class="section-number-2">5.</span> Buffer replacement policies
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              The DBMS decides which page to evict from the buffer pool to free
              up a frame.
            </li>
          </ul>
        </div>
        <div id="outline-container-org5442e67" class="outline-3">
          <h3 id="org5442e67">
            <span class="section-number-3">5.1.</span> Least recently used (LRU)
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                LRU maintains a timestamp of when each page was last accessed,
                and evicts the page with the oldest timestamp.
                <ul class="org-ul">
                  <li>
                    The timestamp can be stored in a queue for efficient
                    sorting.
                  </li>
                </ul>
              </li>
              <li>
                Susceptible to sequential flooding, where the buffer pool is
                corrupted due to a sequential scan.
                <ul class="org-ul">
                  <li>
                    With the LRU policy the oldest pages are evicted, but they
                    are more likely to be scanned soon.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2d21f4d" class="outline-3">
          <h3 id="org2d21f4d">
            <span class="section-number-3">5.2.</span> Clock
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>
                An approximation of LRU but replace the timestamp with a
                reference bit which is set to 1 when a page is accessed.
              </li>
              <li>
                Regularly sweeping all pages, if a bit is set to 1, reset to 0;
                if a bit is 0, evict the page.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8589567" class="outline-3">
          <h3 id="org8589567">
            <span class="section-number-3">5.3.</span> LRU-K
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Tracks the last K accessed timestamps to predict the next
                accessed time, hence avoid the sequential flooding issue.
              </li>
            </ul>
          </div>
          <div id="outline-container-org60fb0f6" class="outline-4">
            <h4 id="org60fb0f6">
              <span class="section-number-4">5.3.1.</span> MySQL approximate
              LRU-K
            </h4>
            <div class="outline-text-4" id="text-5-3-1">
              <ul class="org-ul">
                <li>
                  Use a linked list with two entry points: &ldquo;old&rdquo; and
                  &ldquo;young&rdquo;.
                </li>
                <li>
                  The new pages are always inserted to the head of
                  &ldquo;old&rdquo;.
                </li>
                <li>
                  If a page in the &ldquo;old&rdquo; is accessed again, it is
                  then inserted to the head of &ldquo;young&rdquo;.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org8442957" class="outline-3">
          <h3 id="org8442957">
            <span class="section-number-3">5.4.</span> Localization
          </h3>
          <div class="outline-text-3" id="text-5-4">
            <ul class="org-ul">
              <li>
                Instead of using a global replacement policy, the DBMS make
                eviction decisions based on each query.
              </li>
              <li>
                Pages brought in by one query are less likely to evict pages
                that are important for other ongoing queries.
              </li>
              <li>
                The DBMS can <b><b>predicts</b></b> more accurately which pages
                should stay or be evicted once the query is complete, so that
                the buffer pool is less polluted with less useful pages.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgeb7a1fd" class="outline-3">
          <h3 id="orgeb7a1fd">
            <span class="section-number-3">5.5.</span> Priority hint
          </h3>
          <div class="outline-text-3" id="text-5-5">
            <ul class="org-ul">
              <li>
                Transactions tell the buffer pool where pages are important
                based on the <b><b>context</b></b> of each page.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org50e6724" class="outline-3">
          <h3 id="org50e6724">
            <span class="section-number-3">5.6.</span> Dirty pages
          </h3>
          <div class="outline-text-3" id="text-5-6">
            <ul class="org-ul">
              <li>
                Two ways to handle dirty pages in the buffer pool:
                <ul class="org-ul">
                  <li>Fast: only drop clean pages.</li>
                  <li>
                    Slow: write back dirty pages to ensure persistent change,
                    and then evict them (if they will not be read again.).
                  </li>
                </ul>
              </li>
              <li>
                Can periodically walk through the page table and write back
                dirty pages in the background.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org44ca5e9" class="outline-2">
        <h2 id="org44ca5e9">
          <span class="section-number-2">6.</span> Other memory pools
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>
              A DBMS also maintains other pools to store:
              <ul class="org-ul">
                <li>query caches,</li>
                <li>logs,</li>
                <li>temporary tables, e.g., sorting, join,</li>
                <li>dictionary caches.</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org21effca" class="outline-2">
        <h2 id="org21effca">
          <span class="section-number-2">7.</span> OS cache bypass
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              Most DBMS use direct I/O (e.g., with <code>fsync</code> instead of
              <code>fwrite</code>) to bypass the OS cache to avoid redundant
              page copy and to manage eviction policies more intelligently (cf.
              <a
                href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org611ff38"
                >Why not OS post</a
              >).
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org3b99925" class="outline-2">
        <h2 id="org3b99925">
          <span class="section-number-2">8.</span> I/O scheduling
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              The DBMS maintains internal <b><b>queue</b></b> to track page
              read/write.
            </li>
            <li>
              The priority are determined by multi-facets, e.g., critical path
              task, SLAs.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">08 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-08-db-notes:-storage-models-&-compression.html"
          >CMU 15-445 notes: Storage Models & Compression</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org85a1c9b">1. Database workloads</a>
              <ul>
                <li>
                  <a href="#org4b1d669"
                    >1.1. OLTP (Online Transaction Processing)</a
                  >
                </li>
                <li>
                  <a href="#org6bce54a"
                    >1.2. OLAP (Online Analytical Processing)</a
                  >
                </li>
                <li><a href="#orgc0961e0">1.3. HTAP (Hybrid)</a></li>
              </ul>
            </li>
            <li>
              <a href="#org4813278">2. Storage models</a>
              <ul>
                <li>
                  <a href="#org6a897a6">2.1. N-ary Storage Model (NSM)</a>
                </li>
                <li>
                  <a href="#orgba64f33"
                    >2.2. Decomposition Storage Model (DSM)</a
                  >
                </li>
                <li>
                  <a href="#org56babf1"
                    >2.3. Partition Attributes Across (PAX)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgac94013">3. Database compression</a>
              <ul>
                <li><a href="#org9f06ac0">3.1. Compression granularity</a></li>
                <li><a href="#org49dfe33">3.2. Naive compression</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgd8cef0f">4. Columnar compression</a>
              <ul>
                <li><a href="#orgeb97923">4.1. Dictionary encoding</a></li>
                <li>
                  <a href="#org8cc690b">4.2. Run-Length encoding (RLE)</a>
                </li>
                <li><a href="#org99c27c8">4.3. Bit-packing encoding</a></li>
                <li><a href="#org16ea5e2">4.4. Mostly encoding</a></li>
                <li>
                  <a href="#orgdca6d3c">4.5. Bitmap (One-hot) encoding</a>
                </li>
                <li><a href="#org6283a50">4.6. Delta encoding</a></li>
                <li><a href="#org3992a89">4.7. Incremental encoding</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/05-storage3.pdf"
          >CMU 15-445 L5 notes</a
        >.
      </p>
      <div id="outline-container-org85a1c9b" class="outline-2">
        <h2 id="org85a1c9b">
          <span class="section-number-2">1.</span> Database workloads
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org4b1d669" class="outline-3">
          <h3 id="org4b1d669">
            <span class="section-number-3">1.1.</span> OLTP (Online Transaction
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Characterized by fast, repetitive, simple queries that operator
                on a small amount of data, e.g., a user adds an item to its
                Amazon cart and pay.
              </li>
              <li>Usually more writes than read.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6bce54a" class="outline-3">
          <h3 id="org6bce54a">
            <span class="section-number-3">1.2.</span> OLAP (Online Analytical
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Characterized by complex read queries on large data.</li>
              <li>E.g., compute the most popular item in a period.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgc0961e0" class="outline-3">
          <h3 id="orgc0961e0">
            <span class="section-number-3">1.3.</span> HTAP (Hybrid)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>OLTP + OLAP.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org4813278" class="outline-2">
        <h2 id="org4813278">
          <span class="section-number-2">2.</span> Storage models
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Different ways to store tuples in pages.</li>
          </ul>
        </div>
        <div id="outline-container-org6a897a6" class="outline-3">
          <h3 id="org6a897a6">
            <span class="section-number-3">2.1.</span> N-ary Storage Model (NSM)
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                Store all attributes for a single tuple contiguously in a single
                page, e.g., slotted pages.
              </li>
              <li>
                Pros: good for queries that need the entire tuple, e.g., OLTP.
              </li>
              <li>
                Cons: inefficient for scanning large data with a few attributes,
                e.g., OLAP.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgba64f33" class="outline-3">
          <h3 id="orgba64f33">
            <span class="section-number-3">2.2.</span> Decomposition Storage
            Model (DSM)
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                Store each attribute for all tuples contiguously in a block of
                data, i.e., column store.
              </li>
              <li>
                Pros: save I/O; better data compression; ideal for bulk single
                attribute queries like OLAP.
              </li>
              <li>
                Cons: slow for point queries due to tuple splitting, e.g., OLTP.
              </li>
              <li>
                2 common ways to put back tuples:
                <ul class="org-ul">
                  <li>
                    Most common: use fixed-length offsets, e.g., the value in a
                    given column belong to the same tuple as the value in
                    another column at the same offset.
                  </li>
                  <li>
                    Less common: use embedded tuple ids, e.g., each attribute is
                    associated with the tuple id, and the DBMS stores a mapping
                    to jump to any attribute with the given tuple id.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="orgc775856">
              <img
                src="./static/db-dsm-storage-model.png"
                alt="db-dsm-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>DSM storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org56babf1" class="outline-3">
          <h3 id="org56babf1">
            <span class="section-number-3">2.3.</span> Partition Attributes
            Across (PAX)
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Rows are horizontally partitioned into groups of rows; each row
                group uses a column store.
              </li>
              <li>
                A PAX file has a global header containing a directory with each
                row group&rsquo;s offset; each row group maintains its own
                header with content metadata.
              </li>
            </ul>

            <figure id="org8caf991">
              <img
                src="./static/db-pax-storage-model.png"
                alt="db-pax-storage-model.png"
                align="center"
                width="300px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>PAX storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-orgac94013" class="outline-2">
        <h2 id="orgac94013">
          <span class="section-number-2">3.</span> Database compression
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Disk I/O is always the main bottleneck; read-only analytical
              workloads are popular; compression in advance allows for more I/O
              throughput.
            </li>
            <li>
              <b><b>Real-world</b></b> data sets have the following properties
              for compression:
              <ul class="org-ul">
                <li>
                  <b><b>Highly skewed</b></b> distributions for attribute
                  values.
                </li>
                <li>
                  <b><b>High correlation</b></b> between attributes of the same
                  tuple, e.g., zip code to city.
                </li>
              </ul>
            </li>
            <li>
              Requirements on the database compression:
              <ul class="org-ul">
                <li>
                  Fixed-length values to follow word-alignment; variable length
                  data stored in separate mappings.
                </li>
                <li>
                  Postpone decompression as long as possible during query
                  execution, i.e., <b><b>late materialization</b></b
                  >.
                </li>
                <li>
                  Lossless; any lossy compression can only be performed at the
                  application level.
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <div id="outline-container-org9f06ac0" class="outline-3">
          <h3 id="org9f06ac0">
            <span class="section-number-3">3.1.</span> Compression granularity
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>Block level: compress all tuples for the same table.</li>
              <li>Tuple level: compress each tuple (NSM only).</li>
              <li>
                Attribute level: compress one or multiple values within one
                tuple.
              </li>
              <li>
                Columnar level: compress one or multiple columns across multiple
                tuples (DSM only).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org49dfe33" class="outline-3">
          <h3 id="org49dfe33">
            <span class="section-number-3">3.2.</span> Naive compression
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <ul class="org-ul">
              <li>
                Engineers often use a general purpose compression algorithm with
                lower compression ratio in exchange for faster
                compression/decompression.
              </li>
              <li>
                E.g., compress disk pages by padding them to a power of 2KBs and
                storing them in the buffer pool.
                <ul class="org-ul">
                  <li>
                    Why small chunk: must decompress before reading/writing the
                    data every time, hence need o limit the compression scope.
                  </li>
                </ul>
              </li>
              <li>
                Does not consider the high-level data semantics, thus cannot
                utilize late materialization.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgd8cef0f" class="outline-2">
        <h2 id="orgd8cef0f">
          <span class="section-number-2">4.</span> Columnar compression
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              Works best with OLAP, may need additional support for writes.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgeb97923" class="outline-3">
          <h3 id="orgeb97923">
            <span class="section-number-3">4.1.</span> Dictionary encoding
          </h3>
          <div class="outline-text-3" id="text-4-1">
            <ul class="org-ul">
              <li>
                The most common database compression scheme, support late
                materialization.
              </li>
              <li>
                Replace frequent value patterns with smaller codes, and use a
                dictionary to map codes to their original values.
              </li>
              <li>
                Need to support fast encoding and decoding, so hash function is
                impossible.
              </li>
              <li>
                Need to support order-preserving encodings, i.e., sorting codes
                in the same order as original values, to support
                <b><b>range queries</b></b
                >.
                <ul class="org-ul">
                  <li>
                    E.g., when <code>SELECT DISTINCT</code> with
                    pattern-matching, the DBMS only needs to scan the encoding
                    dictionary (but without <code>DISTINCT</code> it still needs
                    to scan the whole column).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8cc690b" class="outline-3">
          <h3 id="org8cc690b">
            <span class="section-number-3">4.2.</span> Run-Length encoding (RLE)
          </h3>
          <div class="outline-text-3" id="text-4-2">
            <ul class="org-ul">
              <li>
                Compress runs (consecutive instances) of the same value in a
                column into triplets <code>(value, offset, length)</code>.
              </li>
              <li>
                Need to cluster same column values to maximize the compression.
              </li>
            </ul>

            <figure id="org6382298">
              <img
                src="./static/db-rle-storage-model.png"
                alt="db-rle-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>Run-length encoding
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org99c27c8" class="outline-3">
          <h3 id="org99c27c8">
            <span class="section-number-3">4.3.</span> Bit-packing encoding
          </h3>
          <div class="outline-text-3" id="text-4-3">
            <ul class="org-ul">
              <li>Use less bits to store an attribute.</li>
            </ul>

            <figure id="orgf423227">
              <img
                src="./static/db-bit-packing-storage-model.png"
                alt="db-bit-packing-storage-model.png"
                align="center"
                width="250px"
              />

              <figcaption>
                <span class="figure-number">Figure 4: </span>Bit-packing
                encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org16ea5e2" class="outline-3">
          <h3 id="org16ea5e2">
            <span class="section-number-3">4.4.</span> Mostly encoding
          </h3>
          <div class="outline-text-3" id="text-4-4">
            <ul class="org-ul">
              <li>
                Use a special marker to indicate values that exceed the bit size
                and maintains a look-up table to store them.
              </li>
            </ul>

            <figure id="orgd9086f0">
              <img
                src="./static/db-mostly-encoding-storage-model.png"
                alt="db-mostly-encoding-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 5: </span>Mostly encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgdca6d3c" class="outline-3">
          <h3 id="orgdca6d3c">
            <span class="section-number-3">4.5.</span> Bitmap (One-hot) encoding
          </h3>
          <div class="outline-text-3" id="text-4-5">
            <ul class="org-ul">
              <li>Only practical if the value cardinality is low.</li>
            </ul>

            <figure id="org128413a">
              <img
                src="./static/db-bitmap-encoding-storage-model.png"
                alt="db-bitmap-encoding-storage-model.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 6: </span>Bitmap encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org6283a50" class="outline-3">
          <h3 id="org6283a50">
            <span class="section-number-3">4.6.</span> Delta encoding
          </h3>
          <div class="outline-text-3" id="text-4-6">
            <ul class="org-ul">
              <li>
                Record the difference between values; the base value can be
                stored in-line or in a separate look-up table.
              </li>
              <li>Can be combined with RLE encoding.</li>
            </ul>

            <figure id="orgad0e884">
              <img
                src="./static/db-delta-encoding-storage-model.png"
                alt="db-delta-encoding-storage-model.png"
                align="center"
                width="500px"
              />

              <figcaption>
                <span class="figure-number">Figure 7: </span>Delta encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org3992a89" class="outline-3">
          <h3 id="org3992a89">
            <span class="section-number-3">4.7.</span> Incremental encoding
          </h3>
          <div class="outline-text-3" id="text-4-7">
            <ul class="org-ul">
              <li>
                Common prefixes or suffixes and their lengths are recorded to
                avoid duplication.
              </li>
              <li>Need to sort the data first.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">31 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-31-db-notes:-database-storage.html"
          >CMU 15-445 notes: Database storage</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org319373f">1. Data storage</a>
              <ul>
                <li><a href="#org25b5d83">1.1. Volatile device</a></li>
                <li><a href="#orgbd2989a">1.2. Non-volatile device</a></li>
                <li><a href="#org2549b27">1.3. Storage hierarchy</a></li>
                <li><a href="#org0a06bab">1.4. Persistent memory</a></li>
                <li>
                  <a href="#org6a7701a"
                    >1.5. NVM (non-volatile memory express)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgcf1d613">2. DBMS architecture</a>
              <ul>
                <li><a href="#orgf2107fc">2.1. Why not OS</a></li>
              </ul>
            </li>
            <li>
              <a href="#org16bffda">3. Database pages</a>
              <ul>
                <li><a href="#org73ef5c7">3.1. Hardware page</a></li>
              </ul>
            </li>
            <li><a href="#org94011df">4. Database heap</a></li>
            <li>
              <a href="#org75e5706">5. Page layout</a>
              <ul>
                <li><a href="#org8991551">5.1. Slotted-pages</a></li>
                <li>
                  <a href="#orgc6dd4aa">5.2. Log-structured</a>
                  <ul>
                    <li><a href="#org84bc193">5.2.1. Log compaction</a></li>
                  </ul>
                </li>
                <li><a href="#orgb763158">5.3. Index-organized storage</a></li>
              </ul>
            </li>
            <li>
              <a href="#org5e4dc12">6. Tuple layout</a>
              <ul>
                <li><a href="#org06b0ba1">6.1. Denormalized tuple data</a></li>
              </ul>
            </li>
            <li>
              <a href="#org2564126">7. Data representation</a>
              <ul>
                <li><a href="#org7326ecb">7.1. Integers</a></li>
                <li>
                  <a href="#orgd4abbd1">7.2. Variable precision numbers</a>
                </li>
                <li>
                  <a href="#orgea044a1">7.3. Fixed-point precision numbers</a>
                </li>
                <li><a href="#org5e76a22">7.4. Variable-length data</a></li>
                <li><a href="#orgb5204b9">7.5. Dates/Times</a></li>
                <li><a href="#org39e2a57">7.6. Null</a></li>
              </ul>
            </li>
            <li><a href="#orgabac144">8. System catalogs</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf"
          >CMU 15-445 L3 notes</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf"
          >CMU 15-445 L4 notes</a
        >.
      </p>
      <div id="outline-container-org319373f" class="outline-2">
        <h2 id="org319373f">
          <span class="section-number-2">1.</span> Data storage
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org25b5d83" class="outline-3">
          <h3 id="org25b5d83">
            <span class="section-number-3">1.1.</span> Volatile device
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>The data is lost once the power is off.</li>
              <li>
                Support fast random access with byte-addressable locations,
                i.e., can jump to any byte address and access the data.
              </li>
              <li>A.k.a memory, e.g., DRAM.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgbd2989a" class="outline-3">
          <h3 id="orgbd2989a">
            <span class="section-number-3">1.2.</span> Non-volatile device
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>The data is retained after the power is off.</li>
              <li>
                Block/Page addressable, i.e., in order to read a value at a
                particular offset, first need to load 4KB page into memory that
                holds the value.
              </li>
              <li>
                Perform better for sequential access, i.e., contiguous chunks.
              </li>
              <li>
                A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning
                hard drives).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2549b27" class="outline-3">
          <h3 id="org2549b27">
            <span class="section-number-3">1.3.</span> Storage hierarchy
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>Close to CPU: faster, smaller, more expensive.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org0a06bab" class="outline-3">
          <h3 id="org0a06bab">
            <span class="section-number-3">1.4.</span> Persistent memory
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>As fast as DRAM, with the persistence of disk.</li>
              <li>Not in widespread production use.</li>
              <li>A.k.a, non-volatile memory.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6a7701a" class="outline-3">
          <h3 id="org6a7701a">
            <span class="section-number-3">1.5.</span> NVM (non-volatile memory
            express)
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                NAND flash drives that connect over an improved hardware
                interface to allow faster transfer.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgcf1d613" class="outline-2">
        <h2 id="orgcf1d613">
          <span class="section-number-2">2.</span> DBMS architecture
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Primary storage location of the database is on disks.</li>
            <li>
              The DBMS is responsible for data movement between disk and memory
              with a buffer pool.
            </li>
            <li>
              The data is organized into pages by the storage manager; the first
              page is the directory page
            </li>
            <li>
              To execute the query, the execution engine asks the buffer pool
              for a page; the buffer pool brings the page to the memory, gives
              the execution engine the page pointer, and ensures the page is
              retained in the memory while being executed.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgf2107fc" class="outline-3">
          <h3 id="orgf2107fc">
            <span class="section-number-3">2.1.</span> Why not OS
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                The architecture is like virtual memory: a large address space
                and a place for the OS to bring the pages from the disk.
              </li>
              <li>
                The OS way to achieve virtual memory is to use
                <code>mmap</code> to map the contents of a file in a process
                address space, and the OS is responsible for the data movement.
              </li>
              <li>
                If <code>mmap</code> hits a page fault, the process is blocked;
                however a DBMS should be able to still process other queries.
              </li>
              <li>
                A DBMS knows more about the data being processed (the OS cannot
                decode the file contents) and can do better than OS.
              </li>
              <li>
                Can still use some OS operations:
                <ul class="org-ul">
                  <li>
                    <code>madvise</code>: tell the OS when DBMS is planning on
                    reading some page.
                  </li>
                  <li>
                    <code>mlock</code>: tell the OS to not swap ranges outs of
                    disk.
                  </li>
                  <li>
                    <code>msync</code>: tell the OS to flush memory ranges out
                    to disk, i.e., write.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org16bffda" class="outline-2">
        <h2 id="org16bffda">
          <span class="section-number-2">3.</span> Database pages
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>Usually fixed-sized blocks of data.</li>
            <li>
              Can contain different data types, e.g., tuples, indexes; data of
              different types are usually not mixed within the same page.
            </li>
            <li>
              Some DBMS requires each page is self-contained, i.e., a tuple does
              not point to another page.
            </li>
            <li>
              Each page is given a unique id, which can be mapped to the file
              path and offset to find the page.
            </li>
          </ul>
        </div>
        <div id="outline-container-org73ef5c7" class="outline-3">
          <h3 id="org73ef5c7">
            <span class="section-number-3">3.1.</span> Hardware page
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                The storage that a device guarantees an atomic write, i.e., if
                the hardware page is 4KB and the DBMS tries to write 4KB to the
                disk, either all 4KB is written or none is.
              </li>
              <li>
                If the database page is larger than the hardware page, the DBMS
                requires extra measures to ensure the writing atomicity itself.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org94011df" class="outline-2">
        <h2 id="org94011df">
          <span class="section-number-2">4.</span> Database heap
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              A heap file (e.g., a table) is an unordered collection of pages
              where tuples are stored in random order.
            </li>
            <li>
              To locate a page in a heap file, a DBMS can use either a linked
              list or a page directory.
              <ul class="org-ul">
                <li>
                  Linked list: the header page holds a pointer to a list of data
                  and free pages; require a sequential scan when finding a
                  specific page.
                </li>
                <li>
                  Page directory: a DBMS uses special pages to track the
                  location of each data page and the free space in database
                  files.
                  <ul class="org-ul">
                    <li>
                      All changes to the page directory must be recorded on disk
                      to allow the DBMS to find on restart.
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org75e5706" class="outline-2">
        <h2 id="org75e5706">
          <span class="section-number-2">5.</span> Page layout
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              Each page includes a header to record the page meta-data, e.g.,
              page size, checksum, version.
            </li>
            <li>
              Two main approaches to laying out data in pages: slotted-pages and
              log-structured.
            </li>
          </ul>
        </div>
        <div id="outline-container-org8991551" class="outline-3">
          <h3 id="org8991551">
            <span class="section-number-3">5.1.</span> Slotted-pages
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                The header keeps track of the number of used slots, the offset
                of the starting of each slot.
              </li>
              <li>
                When adding a tuple, the slot array grows from the beginning to
                the end, the tuple data grows from the end to the beginning; the
                page is full when they meet.
              </li>
              <li>
                Problems associated with this layout are:
                <ul class="org-ul">
                  <li>
                    Fragmentation: tuple deletions leave gaps in the pages.
                  </li>
                  <li>
                    Inefficient disk I/O: need to fetch the entire block to
                    update a tuple; users could randomly jump to multiple
                    different pages to update a tuple.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="orgf96faf5">
              <img
                src="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                alt="1*7AuKrdEJQpfRYhavwWzwhg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>Slotted pages (<a
                  href="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgc6dd4aa" class="outline-3">
          <h3 id="orgc6dd4aa">
            <span class="section-number-3">5.2.</span> Log-structured
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>Only allows creations of new pages and no overwrites.</li>
              <li>
                Stores the log records of changes to the tuples; the DBMS
                appends new log entries to an in-memory buffer without checking
                previous records -&gt; fast writes.
              </li>
              <li>
                Potentially slow reads; can be optimized by bookkeeping the
                latest write of each tuple.
              </li>
            </ul>
          </div>
          <div id="outline-container-org84bc193" class="outline-4">
            <h4 id="org84bc193">
              <span class="section-number-4">5.2.1.</span> Log compaction
            </h4>
            <div class="outline-text-4" id="text-5-2-1">
              <ul class="org-ul">
                <li>
                  Take only the most recent change for each tuple across several
                  pages.
                </li>
                <li>
                  There is only one entry for each tuple after the compaction,
                  and can be easily sorted by id for faster lookup -&gt; called
                  Sorted String Table (SSTable).
                </li>
                <li>Universal compaction: any log files can be compacted.</li>
                <li>
                  Level compaction: level 0 (smallest) files can be compacted to
                  created a level 1 file.
                </li>
                <li>
                  Write amplification issue: for each logical write, there could
                  be multiple physical writes.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-orgb763158" class="outline-3">
          <h3 id="orgb763158">
            <span class="section-number-3">5.3.</span> Index-organized storage
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Both page-oriented and log-structured storage rely on additional
                index to find a tuple since tables are inherently unsorted.
              </li>
              <li>
                In an index-organized storage scheme, the DBMS stores tuples as
                the value of an index data structure.
              </li>
              <li>
                E.g., In a B-tree indexed DBMS, the index (i.e., primary keys)
                are stored as the intermediate nodes, and the data is stored in
                the leaf nodes.
              </li>
            </ul>

            <figure id="orgfd07c3b">
              <img
                src="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                alt="cncpt272.gif"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Index-organized
                storage (<a
                  href="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-org5e4dc12" class="outline-2">
        <h2 id="org5e4dc12">
          <span class="section-number-2">6.</span> Tuple layout
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>Tuple: a sequence of bytes for a DBMS to decode.</li>
            <li>
              Tuple header: contains tuple meta-data, e.g., visibility
              information (which transactions write the tuple).
            </li>
            <li>Tuple data: cannot exceed the size of a page.</li>
            <li>
              Unique id: usually page id + offset/slot; an application cannot
              rely on it to mean anything.
            </li>
          </ul>
        </div>
        <div id="outline-container-org06b0ba1" class="outline-3">
          <h3 id="org06b0ba1">
            <span class="section-number-3">6.1.</span> Denormalized tuple data
          </h3>
          <div class="outline-text-3" id="text-6-1">
            <ul class="org-ul">
              <li>
                If two tables are related, a DBMS can &ldquo;pre-join&rdquo;
                them so that the tables are on the same page.
              </li>
              <li>
                The read is faster since only one page is required to load, but
                the write is more expensive since a tuple needs more space (<b
                  ><b>not free lunch in DB system!</b></b
                >).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org2564126" class="outline-2">
        <h2 id="org2564126">
          <span class="section-number-2">7.</span> Data representation
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              A data representation scheme specifies how a DBMS stores the bytes
              of a tuple.
            </li>
            <li>
              Tuples can be word-aligned via padding or attribute reordering to
              make sure the CPU can access a tuple without unexpected behavior.
            </li>
            <li>
              5 high level data types stored in a tuple: integer,
              variable-precision numbers, fixed-point precision numbers,
              variable length values, dates/times.
            </li>
          </ul>
        </div>
        <div id="outline-container-org7326ecb" class="outline-3">
          <h3 id="org7326ecb">
            <span class="section-number-3">7.1.</span> Integers
          </h3>
          <div class="outline-text-3" id="text-7-1">
            <ul class="org-ul">
              <li>
                Fixed length, usually stored using the DBMS native C/C++ types.
              </li>
              <li>E.g., <code>INTEGER</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd4abbd1" class="outline-3">
          <h3 id="orgd4abbd1">
            <span class="section-number-3">7.2.</span> Variable precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-2">
            <ul class="org-ul">
              <li>
                Inexact, variable-precision numeric types; fast than arbitrary
                precision numbers.
              </li>
              <li>Could have rounding errors.</li>
              <li>E.g., <code>REAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgea044a1" class="outline-3">
          <h3 id="orgea044a1">
            <span class="section-number-3">7.3.</span> Fixed-point precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-3">
            <ul class="org-ul">
              <li>
                Arbitrary precision data type stored in exact, variable-length
                binary representation (almost like a string) with additional
                meta-data (e.g., length, decimal position).
              </li>
              <li>E.g., <code>DECIMAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org5e76a22" class="outline-3">
          <h3 id="org5e76a22">
            <span class="section-number-3">7.4.</span> Variable-length data
          </h3>
          <div class="outline-text-3" id="text-7-4">
            <ul class="org-ul">
              <li>
                Represent data of arbitrary length, usually stored with a header
                to keep the track of the length and the checksum.
              </li>
              <li>
                Overflowed data is stored on a special overflow page referenced
                by the tuple, the overflow page can also contain pointers to
                next overflow pages.
              </li>
              <li>
                Some DBMS allows to store files (e.g., photos) externally, but
                the DBMS cannot modify them.
              </li>
              <li>E.g., <code>BLOB</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb5204b9" class="outline-3">
          <h3 id="orgb5204b9">
            <span class="section-number-3">7.5.</span> Dates/Times
          </h3>
          <div class="outline-text-3" id="text-7-5">
            <ul class="org-ul">
              <li>
                Usually represented as unit time, e.g., micro/milli-seconds.
              </li>
              <li>E.g., <code>TIMESTAMP</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org39e2a57" class="outline-3">
          <h3 id="org39e2a57">
            <span class="section-number-3">7.6.</span> Null
          </h3>
          <div class="outline-text-3" id="text-7-6">
            <ul class="org-ul">
              <li>
                3 common approaches to represent nulls:
                <ul class="org-ul">
                  <li>
                    Most common: store a bitmap in a centralized header to
                    specify which attributes are null.
                  </li>
                  <li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
                  <li>
                    Not recommended: store a flag per attribute to mark a value
                    is null; may need more bits to ensure word alignment.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgabac144" class="outline-2">
        <h2 id="orgabac144">
          <span class="section-number-2">8.</span> System catalogs
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              A DBMS maintains an internal catalog table for the table
              meta-data, e.g., tables/columns, user permissions, table
              statistics.
            </li>
            <li>Bootstrapped by special code.</li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">23 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-23-db-notes:-modern-sql.html"
          >CMU 15-445 notes: Modern SQL</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgf722d34">1. Terminology</a>
              <ul>
                <li>
                  <a href="#orgb16502e">1.1. SQL and relational algebra</a>
                </li>
                <li><a href="#org7894974">1.2. SQL commands</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgb5bfeb2">2. SQL syntax</a>
              <ul>
                <li><a href="#orgcde9ce0">2.1. Join</a></li>
                <li><a href="#orgb2910a7">2.2. Aggregation function</a></li>
                <li><a href="#org6793947">2.3. String operation</a></li>
                <li><a href="#org1ae8457">2.4. Date and time</a></li>
                <li><a href="#orgbf5b8e0">2.5. Output redirection</a></li>
                <li><a href="#org763e3e1">2.6. Output control</a></li>
                <li><a href="#orgda9e7b8">2.7. Nested queries</a></li>
                <li><a href="#org704520c">2.8. Window functions</a></li>
                <li>
                  <a href="#org065738a">2.9. Common Table Expressions (CTE)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf"
          >CMU 15-445 L2 notes</a
        >, along with some SQL command explained by
        <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgf722d34" class="outline-2">
        <h2 id="orgf722d34">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orgb16502e" class="outline-3">
          <h3 id="orgb16502e">
            <span class="section-number-3">1.1.</span> SQL and relational
            algebra
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Relational algebra is based on sets (unordered, no duplicates);
                SQL is based on bags (unordered, allows duplicates).
              </li>
              <li>
                SQL is a declarative query language; users use SQL to specify
                the desired result, each DBMS determines the most efficient
                strategy to produce the answer.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7894974" class="outline-3">
          <h3 id="org7894974">
            <span class="section-number-3">1.2.</span> SQL commands
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Data manipulation language (DML): <code>SELECT</code>,
                <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.
              </li>
              <li>
                <p>Data definition language (DDL): <code>CREATE</code>.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
                </div>
              </li>
              <li>Data control language (DCL): security, access control.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgb5bfeb2" class="outline-2">
        <h2 id="orgb5bfeb2">
          <span class="section-number-2">2.</span> SQL syntax
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-orgcde9ce0" class="outline-3">
          <h3 id="orgcde9ce0">
            <span class="section-number-3">2.1.</span> Join
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                <p>
                  Combine columns from one or more tables and produces a new
                  table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb2910a7" class="outline-3">
          <h3 id="orgb2910a7">
            <span class="section-number-3">2.2.</span> Aggregation function
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <code>AVG(COL)</code>, <code>MIN(COL)</code>,
                <code>MAX(COL)</code>, <code>COUNT(COL)</code>.
              </li>
              <li>
                <p>
                  Take as input a bag of tuples and produce a single scalar
                  value.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
                </div>
              </li>
              <li>
                <p>
                  Non-aggregated values in <code>SELECT</code> output must
                  appear in <code>GROUP BY</code>.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
                </div>
              </li>
              <li>
                <p>
                  <code>HAVING</code>: filter output results based on
                  aggregation computation.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6793947" class="outline-3">
          <h3 id="org6793947">
            <span class="section-number-3">2.3.</span> String operation
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Strings are case sensitive and single-quotes only in the SQL
                standard.
              </li>
              <li>
                Use <code>LIKE</code> for string pattern matching:
                <ul class="org-ul">
                  <li><code>%</code> matches any sub-string,</li>
                  <li><code>_</code> matches any one character</li>
                </ul>
              </li>
              <li>
                Standard string functions: <code>UPPER(S)</code>,
                <code>SUBSTRING(S, B, E)</code>.
              </li>
              <li><code>||</code>: string concatenation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1ae8457" class="outline-3">
          <h3 id="org1ae8457">
            <span class="section-number-3">2.4.</span> Date and time
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
              <li>Different DBMS have different date/time operations.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgbf5b8e0" class="outline-3">
          <h3 id="orgbf5b8e0">
            <span class="section-number-3">2.5.</span> Output redirection
          </h3>
          <div class="outline-text-3" id="text-2-5">
            <ul class="org-ul">
              <li>
                <p>One can store the results into another table</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org763e3e1" class="outline-3">
          <h3 id="org763e3e1">
            <span class="section-number-3">2.6.</span> Output control
          </h3>
          <div class="outline-text-3" id="text-2-6">
            <ul class="org-ul">
              <li>
                Use <code>ORDER</code>, <code>ASC</code> and
                <code>DESC</code> to sort the output tuples; otherwise the
                output could have different order every time.
              </li>
              <li>
                <p>
                  Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the
                  output number.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgda9e7b8" class="outline-3">
          <h3 id="orgda9e7b8">
            <span class="section-number-3">2.7.</span> Nested queries
          </h3>
          <div class="outline-text-3" id="text-2-7">
            <ul class="org-ul">
              <li>Nested queries are often difficult to optimize.</li>
              <li>
                The inner query can access attributes defined in the outer
                query.
              </li>
              <li>
                <p>Inner queries can appear anywhere.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
                </div>
              </li>

              <li>
                Nested query results expression:
                <ul class="org-ul">
                  <li>
                    <code>ALL</code>: must satisfy expression for all
                    <b><b>rows</b></b> in sub-query.
                  </li>
                  <li>
                    <code>ANY</code>, <code>IN</code>: must satisfy expression
                    for at least one row in sub-query.
                  </li>
                  <li>
                    <p><code>EXISTS</code>: at least one row is returned.</p>
                    <div class="org-src-container">
                      <pre
                        class="src src-sql"
                      ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org704520c" class="outline-3">
          <h3 id="org704520c">
            <span class="section-number-3">2.8.</span> Window functions
          </h3>
          <div class="outline-text-3" id="text-2-8">
            <ul class="org-ul">
              <li>Perform sliding calculation across a set of tuples.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org065738a" class="outline-3">
          <h3 id="org065738a">
            <span class="section-number-3">2.9.</span> Common Table Expressions
            (CTE)
          </h3>
          <div class="outline-text-3" id="text-2-9">
            <ul class="org-ul">
              <li>
                An alternative to windows or nested queries when writing more
                complex queries.
              </li>
              <li>
                <p>
                  CTEs use <code>WITH</code> to bind the output of an inner
                  query to a temporary table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">17 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-17-db-notes:-relational-model.html"
          >CMU 15-445 notes: Relational Model & Algebra</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgf810877">1. Terminology</a>
              <ul>
                <li><a href="#org3ac888e">1.1. Database</a></li>
                <li>
                  <a href="#org7e7bb2c">1.2. Database design consideration</a>
                </li>
                <li>
                  <a href="#orgec71f6f"
                    >1.3. Database management system (DBMS)</a
                  >
                </li>
                <li><a href="#orga35f109">1.4. Data model</a></li>
                <li><a href="#org3410861">1.5. Schema</a></li>
                <li><a href="#org43212ec">1.6. Entities and Tables</a></li>
                <li><a href="#orgc5f751d">1.7. Attributes and Fields</a></li>
                <li><a href="#orgd785b59">1.8. Logical layer</a></li>
                <li><a href="#org8797eff">1.9. Physical layer</a></li>
                <li>
                  <a href="#org10d492a"
                    >1.10. Data manipulation languages (DMLs)</a
                  >
                </li>
                <li>
                  <a href="#orgaa47a03"
                    >1.11. SQL (Structured Query Language) and relational
                    model</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org69e6c39">2. Relational model</a>
              <ul>
                <li><a href="#org5611a8a">2.1. A relation</a></li>
                <li><a href="#orga56e189">2.2. A domain</a></li>
                <li><a href="#org12961ea">2.3. A tuple</a></li>
                <li><a href="#org1fa950f">2.4. Keys</a></li>
              </ul>
            </li>
            <li><a href="#org1769975">3. Relational Algebra</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;index=2"
          >CMU 15-445 L1 video</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/01-introduction.pdf"
          >CMU 15-445 L1 notes</a
        >, along with some terminology explained by
        <a href="https://claude.ai/chat/14f3c4ec-0ca8-495e-ac70-dd13f9eab5ea"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgf810877" class="outline-2">
        <h2 id="orgf810877">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org3ac888e" class="outline-3">
          <h3 id="org3ac888e">
            <span class="section-number-3">1.1.</span> Database
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                An organized collection of inter-related data that models some
                aspect of the real-world.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7e7bb2c" class="outline-3">
          <h3 id="org7e7bb2c">
            <span class="section-number-3">1.2.</span> Database design
            consideration
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Data integrity: protect invalid writing.</li>
              <li>Implementation: query complexity, concurrent query.</li>
              <li>Durability: replication, fault tolerance.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgec71f6f" class="outline-3">
          <h3 id="orgec71f6f">
            <span class="section-number-3">1.3.</span> Database management
            system (DBMS)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>A software that manages a database.</li>
              <li>
                Allow the definition, creation, query, update and administration
                of databases.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga35f109" class="outline-3">
          <h3 id="orga35f109">
            <span class="section-number-3">1.4.</span> Data model
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                A conceptual, high-level representation of how data is
                structured
              </li>
              <li>
                Defines entities, attributes, relationships between entities and
                constraints.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org3410861" class="outline-3">
          <h3 id="org3410861">
            <span class="section-number-3">1.5.</span> Schema
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>A concrete implementation of a data model.</li>
              <li>Defines tables, fields, data types, keys and rules.</li>
              <li>Typically represented by a specific database language.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org43212ec" class="outline-3">
          <h3 id="org43212ec">
            <span class="section-number-3">1.6.</span> Entities and Tables
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Entities: conceptual representations of objects in the logical
                data model.
              </li>
              <li>
                Tables: physical storage structures in the physical data model.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgc5f751d" class="outline-3">
          <h3 id="orgc5f751d">
            <span class="section-number-3">1.7.</span> Attributes and Fields
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>Attributes: properties of an entity.</li>
              <li>Fields: columns in a database table.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd785b59" class="outline-3">
          <h3 id="orgd785b59">
            <span class="section-number-3">1.8.</span> Logical layer
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>The entities and attributes the database has.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8797eff" class="outline-3">
          <h3 id="org8797eff">
            <span class="section-number-3">1.9.</span> Physical layer
          </h3>
          <div class="outline-text-3" id="text-1-9">
            <ul class="org-ul">
              <li>How are entities and attributes stored in the database.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org10d492a" class="outline-3">
          <h3 id="org10d492a">
            <span class="section-number-3">1.10.</span> Data manipulation
            languages (DMLs)
          </h3>
          <div class="outline-text-3" id="text-1-10">
            <ul class="org-ul">
              <li>
                Methods to store and retrieve information from a database.
              </li>
              <li>
                Procedural: the query specifies the (high-level) strategy the
                DBMS should use to get the results, e.g., with relational
                algebra.
              </li>
              <li>
                Declarative: the query specifies only what data is desired but
                not how to get it, e.g., with relational calculus (a formal
                language).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgaa47a03" class="outline-3">
          <h3 id="orgaa47a03">
            <span class="section-number-3">1.11.</span> SQL (Structured Query
            Language) and relational model
          </h3>
          <div class="outline-text-3" id="text-1-11">
            <ul class="org-ul">
              <li>
                SQL <b><b>implements</b></b> the relational model in DBMS and
                provides a standard way to create, manipulate and query
                relational databases.
              </li>
              <li>
                Different SQL implementation may vary and do not strictly adhere
                to the relational model, e.g., allow duplicate rows.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org69e6c39" class="outline-2">
        <h2 id="org69e6c39">
          <span class="section-number-2">2.</span> Relational model
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              A <b><b>data model</b></b> that defines a database
              <b><b>abstraction</b></b> to avoid maintenance overhead when
              changing the physical layer.
            </li>
            <li>Data is stored as relations/tables.</li>
            <li>
              Physical layer implementation and execution strategy depends on
              DBMS implementation.
            </li>
          </ul>

          <figure id="orgf7a4cde">
            <img
              src="https://www.guru99.com/images/1/091318_0803_RelationalD1.png"
              alt="091318_0803_RelationalD1.png"
              align="center"
              width="500px"
            />

            <figcaption>
              <span class="figure-number">Figure 1: </span>Relational model
              concepts (<a
                href="https://www.guru99.com/images/1/091318_0803_RelationalD1.png"
                >Source</a
              >)
            </figcaption>
          </figure>
        </div>
        <div id="outline-container-org5611a8a" class="outline-3">
          <h3 id="org5611a8a">
            <span class="section-number-3">2.1.</span> A relation
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                An unordered set that contains the relationship of attributes
                that represent entities.
              </li>
              <li>Relationships are unordered in the relation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga56e189" class="outline-3">
          <h3 id="orga56e189">
            <span class="section-number-3">2.2.</span> A domain
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>A named set of allowable values for a specific attribute.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org12961ea" class="outline-3">
          <h3 id="org12961ea">
            <span class="section-number-3">2.3.</span> A tuple
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>A set of attribute values in the relation.</li>
              <li>Values can also be lists or nested data structures.</li>
              <li>
                <code>Null</code>: a special value in any attribute which means
                the attribute in a tuple is undefined.
              </li>
              <li>\(n-ary\): a relation with \(n\) attributes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1fa950f" class="outline-3">
          <h3 id="org1fa950f">
            <span class="section-number-3">2.4.</span> Keys
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Primary key: uniquely identifies a single tuple.</li>
              <li>
                Foreign key: specifies that an attribute (e.g.,
                <code>CustomerID</code>) in one relation (e.g.,
                <code>OrderTable</code>) has to map to a tuple (e.g., the tuple
                with the same <code>CustomerID</code>) in another relation
                (e.g., <code>CustomerTable</code>).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org1769975" class="outline-2">
        <h2 id="org1769975">
          <span class="section-number-2">3.</span> Relational Algebra
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              A set of fundamental operations to retrieve and manipulate tuples
              in a relation.
            </li>
            <li>
              Each operator takes in one or more relations as inputs, and
              outputs a new relation; operators can be chained.
            </li>
            <li>
              Is a <b><b>procedure language</b></b
              >, meaning the execution always follow the query, even there
              exists more efficient way to get the same result; A better way is
              to be more declarative, e.g., SQL&rsquo;s
              <code>where</code> syntax.
            </li>
            <li>
              <a href="https://i.sstatic.net/AHjRg.png"
                >Common relational algebra</a
              >.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">25 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-25-go-patterns.html"
          >Go patterns</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#orgf3853a8">1. Concurrency vs Parallelism</a></li>
            <li>
              <a href="#org8ef48a9">2. Use goroutines for states</a>
              <ul>
                <li><a href="#org1156ec2">2.1. Matching a regex</a></li>
                <li>
                  <a href="#org43eddd5"
                    >2.2. When the state variable cannot be avoided</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org8d9ca86">3. Pattern 1: publish/subscribe server</a>
              <ul>
                <li>
                  <a href="#org9cdd1ac">3.1. Options for slow goroutines</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This a personal note for the
        <a href="https://www.youtube.com/watch?v=IdCbMO0Ey9I"
          >Russ Cox guest lecture</a
        >.
      </p>
      <div id="outline-container-orgf3853a8" class="outline-2">
        <h2 id="orgf3853a8">
          <span class="section-number-2">1.</span> Concurrency vs Parallelism
        </h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Concurrency: write a program to handle lot of things at once
              <ul class="org-ul">
                <li>not necessarily faster</li>
              </ul>
            </li>
            <li>
              Parallelism: the program itself can do a lot of computations at
              once
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8ef48a9" class="outline-2">
        <h2 id="org8ef48a9">
          <span class="section-number-2">2.</span> Use goroutines for states
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org1156ec2" class="outline-3">
          <h3 id="org1156ec2">
            <span class="section-number-3">2.1.</span> Matching a regex
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                return if a given string matches a regex: start with
                <code>"</code>, contains arbitrary escape sequence and ends with
                <code>*</code>
              </li>
              <li>
                <p>unclear logic: store states in the data</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #dcaeea;">state</span> := <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">for</span> {
<span class="linenr"> 3: </span>    <span style="color: #dcaeea;">c</span> := <span style="color: #c678dd;">read</span>()
<span class="linenr"> 4: </span>    <span style="color: #51afef;">switch</span> state {
<span class="linenr"> 5: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">first char must be "</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 8: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 9: </span>        }
<span class="linenr">10: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">match the next char</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">12: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ending with " matches</span>
<span class="linenr">13: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">14: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
<span class="linenr">15: </span>        }
<span class="linenr">16: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">17: </span>            state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">18: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">19: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">transition to state 1 to match next char</span>
<span class="linenr">20: </span>            state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">21: </span>        }
<span class="linenr">22: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">23: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">read the char, discard it and</span>
<span class="linenr">24: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>clear logic: store states in the code</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">no variable to store state</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">if</span> <span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 3: </span>    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">c is a Unicode, alas to int32</span>
<span class="linenr"> 6: </span><span style="color: #51afef;">for</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 7: </span>    c = <span style="color: #c678dd;">read</span>()
<span class="linenr"> 8: </span>    <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr"> 9: </span>        <span style="color: #c678dd;">read</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">skip the next char</span>
<span class="linenr">10: </span>    }
<span class="linenr">11: </span>}
<span class="linenr">12: </span><span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org43eddd5" class="outline-3">
          <h3 id="org43eddd5">
            <span class="section-number-3">2.2.</span> When the state variable
            cannot be avoided
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <p>the function needs to return the state</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    state <span style="color: #ECBE7B;">int</span>
<span class="linenr"> 3: </span>}
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    r.state = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">proess each char based on current state</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">10: </span>    <span style="color: #51afef;">switch</span> q.state {
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr">12: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr">13: </span>            <span style="color: #51afef;">return</span> BadInput
<span class="linenr">14: </span>        }
<span class="linenr">15: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">16: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">17: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">18: </span>            <span style="color: #51afef;">return</span> Success
<span class="linenr">19: </span>        }
<span class="linenr">20: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">21: </span>            q.state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">22: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">23: </span>            q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">24: </span>        }
<span class="linenr">25: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">26: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">27: </span>    }
<span class="linenr">28: </span>    <span style="color: #51afef;">return</span> NeedMoreInput
<span class="linenr">29: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>use additional goroutines to hold states</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    char <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr"> 3: </span>    status <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    q.char = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>)
<span class="linenr"> 7: </span>    q.status = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>)
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">need to make sure why and when the goroutine will exit</span>
<span class="linenr"> 9: </span>    <span style="color: #51afef;">go</span> q.<span style="color: #c678dd;">parse</span>()
<span class="linenr">10: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">blocks until it receives an initial status from parse()</span>
<span class="linenr">11: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to ensure that parse() is ready, i.e., q.status = NeedMoreInput</span>
<span class="linenr">12: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">before Write() is called</span>
<span class="linenr">13: </span>    &lt;-q.status
<span class="linenr">14: </span>}
<span class="linenr">15: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write sends the next char to q.char, which will be receivecd by parse()</span>
<span class="linenr">16: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the status is a public state accessible by the user</span>
<span class="linenr">17: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">r</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">18: </span>    q.char &lt;- c
<span class="linenr">19: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for the result</span>
<span class="linenr">20: </span>    <span style="color: #51afef;">return</span> &lt;-q.status
<span class="linenr">21: </span>}
<span class="linenr">22: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoteReader</span>) <span style="color: #c678dd;">parse</span>() {
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> q.<span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr">24: </span>        q.status &lt;- SyntaxError
<span class="linenr">25: </span>        <span style="color: #51afef;">return</span>
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr">28: </span>    <span style="color: #51afef;">for</span> c!= <span style="color: #98be65;">'"'</span> {
<span class="linenr">29: </span>        c = q.<span style="color: #c678dd;">read</span>()
<span class="linenr">30: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">31: </span>            q.<span style="color: #c678dd;">read</span>()
<span class="linenr">32: </span>        }
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>    q.status &lt;- Done
<span class="linenr">35: </span>}
<span class="linenr">36: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a helper function used in parse() to return the next char in q.char</span>
<span class="linenr">37: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">read</span>() <span style="color: #ECBE7B;">int</span> {
<span class="linenr">38: </span>    q.status &lt;- NeedMoreInput
<span class="linenr">39: </span>    <span style="color: #51afef;">return</span> &lt;- q.char
<span class="linenr">40: </span>}
<span class="linenr">41: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">main</span>() {
<span class="linenr">42: </span>    <span style="color: #dcaeea;">q</span> := &amp;<span style="color: #ECBE7B;">quoter</span>{}
<span class="linenr">43: </span>    q.<span style="color: #c678dd;">Init</span>()
<span class="linenr">44: </span>
<span class="linenr">45: </span>    <span style="color: #dcaeea;">input</span> := <span style="color: #98be65;">`"Hello, \"World\""`</span>
<span class="linenr">46: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> input {
<span class="linenr">47: </span>        <span style="color: #dcaeea;">status</span> := q.<span style="color: #c678dd;">Write</span>(c)
<span class="linenr">48: </span>    }
<span class="linenr">49: </span>}
</pre>
                </div>
              </li>
              <li>
                check goroutine blockage
                <ul class="org-ul">
                  <li><code>Ctrl-\</code> sends <code>SIGQUIT</code></li>
                  <li>
                    use the HTTP server&rsquo;s
                    <code>/debug/pprof/goroutine</code> if importing
                    <code>net/http</code>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org8d9ca86" class="outline-2">
        <h2 id="org8d9ca86">
          <span class="section-number-2">3.</span> Pattern 1: publish/subscribe
          server
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>the information goes one way: server -&gt; client</li>
            <li>close a channel to signal no new values will be sent</li>
            <li>
              <p>prefer <code>defer</code> when unlocking the mutex</p>
              <div class="org-src-container">
                <pre
                  class="src src-go"
                ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    mu  <span style="color: #ECBE7B;">sync.Mutex</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">protect sub</span>
<span class="linenr"> 3: </span>    sub <span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">whether a channel should be closed</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    s.sub = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>)
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">publish an event to all subscribed channel</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">10: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">each method could be called many clients</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">12: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> s.sub {
<span class="linenr">13: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a goroutine consumes the channel events too slow</span>
<span class="linenr">14: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then a new event publish has to wait before it can send to the channel</span>
<span class="linenr">15: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can add channel buffer</span>
<span class="linenr">16: </span>        c &lt;- e
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>}
<span class="linenr">19: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel starts to subscribe</span>
<span class="linenr">20: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">21: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">22: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> s.sub[c] {
<span class="linenr">24: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>) <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the mutex wil also be unlocked with defer</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>    s.sub[c] = <span style="color: #a9a1e1;">true</span>
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel cancels the subscription</span>
<span class="linenr">29: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">30: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">31: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">32: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>s.sub[c] {
<span class="linenr">33: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: not subscribed"</span>)
<span class="linenr">34: </span>    }
<span class="linenr">35: </span>    <span style="color: #c678dd;">close</span>(c)
<span class="linenr">36: </span>    <span style="color: #c678dd;">delete</span>(s.sub, c)
<span class="linenr">37: </span>}
</pre>
              </div>
            </li>
          </ul>
        </div>
        <div id="outline-container-org9cdd1ac" class="outline-3">
          <h3 id="org9cdd1ac">
            <span class="section-number-3">3.1.</span> Options for slow
            goroutines
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>slow down event generation</li>
              <li>
                drop events if it cannot be sent, e.g., <code>os/signal</code>,
                <code>runtime/pprof</code>
              </li>
              <li>
                <p>
                  queue events, e.g., add a <code>helper</code> between the
                  server and each client, which also separates the concerns
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">helper</span>(<span style="color: #dcaeea;">in</span> &lt;-<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>, <span style="color: #dcaeea;">out</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">q</span> []<span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if the in is closed, flash out the pending events in q</span>
<span class="linenr"> 4: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and close out</span>
<span class="linenr"> 5: </span>    <span style="color: #51afef;">for</span> in != <span style="color: #a9a1e1;">nil</span> || <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">decide whether and what to send</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">sendOut</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #dcaeea;">Event</span>
<span class="linenr"> 8: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">next</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 9: </span>        <span style="color: #51afef;">if</span> <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr">10: </span>            sendOut = out
<span class="linenr">11: </span>            next = q[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr">12: </span>        }
<span class="linenr">13: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">14: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span>, <span style="color: #dcaeea;">ok</span> := &lt;-in: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">never reaches here after in = nil</span>
<span class="linenr">15: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ok tells whether in is closed</span>
<span class="linenr">16: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>ok {
<span class="linenr">17: </span>                in = <span style="color: #a9a1e1;">nil</span>
<span class="linenr">18: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">19: </span>            }
<span class="linenr">20: </span>            q = <span style="color: #c678dd;">append</span>(q, e)
<span class="linenr">21: </span>        <span style="color: #51afef;">case</span> sendOut &lt;- next: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if len(q) == 0, sendOut = nil</span>
<span class="linenr">22: </span>            q = q[<span style="color: #da8548; font-weight: bold;">1</span>:]
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>    <span style="color: #c678dd;">close</span>(out)
<span class="linenr">26: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>
                  convert mutexes into goroutines, not suitable for Raft where
                  state transition is complex
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    publish   <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    subscribe <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 4: </span>    cancel    <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 5: </span>}
<span class="linenr"> 6: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">subReq</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 7: </span>    c  <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a signal of whether an operation succeeds</span>
<span class="linenr"> 9: </span>    ok <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>
<span class="linenr">10: </span>}
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr">13: </span>    s.publish = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">14: </span>    s.subscribe = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">15: </span>    s.cancel = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">16: </span>    <span style="color: #51afef;">go</span> s.<span style="color: #c678dd;">loop</span>()
<span class="linenr">17: </span>}
<span class="linenr">18: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">19: </span>    s.publish &lt;- e
<span class="linenr">20: </span>}
<span class="linenr">21: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">22: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">23: </span>    s.subscribe &lt;- r
<span class="linenr">24: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">25: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>)
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">29: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">30: </span>    s.cancel &lt;- r
<span class="linenr">31: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">32: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubusb: not subscribed"</span>)
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>}
<span class="linenr">35: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">loop</span>() {
<span class="linenr">36: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">now sub is a local variable, no lock is needed</span>
<span class="linenr">37: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">sub maps from a subscribed channel to a helper channel</span>
<span class="linenr">38: </span>    <span style="color: #dcaeea;">sub</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">39: </span>    <span style="color: #51afef;">for</span> {
<span class="linenr">40: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">41: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span> := &lt;-s.publish:
<span class="linenr">42: </span>            <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">h</span> := <span style="color: #51afef;">range</span> sub {
<span class="linenr">43: </span>                <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the event is published to a helper channel</span>
<span class="linenr">44: </span>                h &lt;- e
<span class="linenr">45: </span>            }
<span class="linenr">46: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">r</span> := &lt;-s.subscribe:
<span class="linenr">47: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the helper channel exists</span>
<span class="linenr">48: </span>            <span style="color: #51afef;">if</span> sub[r.c] != <span style="color: #a9a1e1;">nil</span> {
<span class="linenr">49: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">50: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">51: </span>            }
<span class="linenr">52: </span>            h = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">53: </span>            <span style="color: #51afef;">go</span> <span style="color: #c678dd;">helper</span>(h, r.c)
<span class="linenr">54: </span>            sub[r.c] = h
<span class="linenr">55: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">56: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">c</span> := &lt;-s.cancel:
<span class="linenr">57: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>sub[r.c] == <span style="color: #a9a1e1;">nil</span>{
<span class="linenr">58: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">59: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">60: </span>            }
<span class="linenr">61: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">close the helper channel</span>
<span class="linenr">62: </span>            <span style="color: #c678dd;">close</span>(sub[r.c])
<span class="linenr">63: </span>            <span style="color: #c678dd;">delete</span>(sub, r.c)
<span class="linenr">64: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">65: </span>        }
<span class="linenr">66: </span>    }
<span class="linenr">67: </span>}
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-go.html">go</a>
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-design-pattern.html"
          >design-pattern</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
      </div>

      <div class="post-date">23 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-23-weblab-notes:-react-route.html"
          >Weblab notes: React route</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org032e5d2">1. Router</a></li>
            <li><a href="#orgbc1e437">2. Link</a></li>
            <li>
              <a href="#org36d86a4">3. Workshop 3</a>
              <ul>
                <li><a href="#org3b9116e">3.1. Structure</a></li>
                <li><a href="#orgb07ee88">3.2. States</a></li>
                <li><a href="#orgd7bb6a7">3.3. Props</a></li>
                <li>
                  <a href="#org21edeeb"
                    >3.4. Why passing down the update function in props 1, 4,
                    6?</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <div id="outline-container-org032e5d2" class="outline-2">
        <h2 id="org032e5d2"><span class="section-number-2">1.</span> Router</h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              use the Reach
              <a href="https://reach.tech/router/">Reach Router</a> library
            </li>
            <li>
              <p>URL -&gt; Router -&gt; render different components</p>
              <div class="org-src-container">
                <pre
                  class="src src-js"
                ><span class="linenr">1: </span>&lt;App&gt;
<span class="linenr">2: </span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">conditional rendering based on curren url</span>
<span class="linenr">3: </span>  &lt;Router&gt;
<span class="linenr">4: </span>    &lt;Home path=<span style="color: #98be65;">"/"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">root path</span>
<span class="linenr">5: </span>    &lt;Dashboard path=<span style="color: #98be65;">"dashboard"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">relative to the current URL</span>
<span class="linenr">6: </span>    &lt;Team path=<span style="color: #98be65;">"/team"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">absolute path: root path + "/team"</span>
<span class="linenr">7: </span>    &lt;NotFound <span style="color: #51afef;">default</span> /&gt;
<span class="linenr">8: </span>  &lt;/Router&gt;
<span class="linenr">9: </span>&lt;/App&gt;;
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgbc1e437" class="outline-2">
        <h2 id="orgbc1e437"><span class="section-number-2">2.</span> Link</h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              relative:
              <code class="src src-js"
                >&lt;Link to=<span style="color: #98be65">"newpage"</span
                >&gt;Click me&lt;/Link&gt;</code
              >
            </li>
            <li>
              absolute:
              <code class="src src-js"
                >&lt;Link to=<span style="color: #98be65">"/newpage"</span
                >&gt;Click me&lt;/Link&gt;</code
              >
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org36d86a4" class="outline-2">
        <h2 id="org36d86a4">
          <span class="section-number-2">3.</span> Workshop 3
        </h2>
        <div class="outline-text-2" id="text-3"></div>
        <div id="outline-container-org3b9116e" class="outline-3">
          <h3 id="org3b9116e">
            <span class="section-number-3">3.1.</span> Structure
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <figure id="orgbd7508d">
              <img
                src="./static/workshop-3-structure.png"
                alt="workshop-3-structure.png"
                align="center"
                width="600px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>The Catbook
                structure in workshop 3
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgb07ee88" class="outline-3">
          <h3 id="orgb07ee88">
            <span class="section-number-3">3.2.</span> States
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <table>
              <colgroup>
                <col class="org-center" />
              </colgroup>

              <colgroup>
                <col class="org-left" />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" class="org-center">name</th>
                  <th scope="col" class="org-left">states</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="org-center">Feed</td>
                  <td class="org-left">
                    <code>stories</code>: a list of stories
                  </td>
                </tr>

                <tr>
                  <td class="org-center">Card</td>
                  <td class="org-left">
                    <code>comments</code>: a list of comments for a story id
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="outline-container-orgd7bb6a7" class="outline-3">
          <h3 id="orgd7bb6a7">
            <span class="section-number-3">3.3.</span> Props
          </h3>
          <div class="outline-text-3" id="text-3-3">
            <table>
              <colgroup>
                <col class="org-center" />
              </colgroup>

              <colgroup>
                <col class="org-left" />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" class="org-center">index</th>
                  <th scope="col" class="org-left">props</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="org-center">1</td>
                  <td class="org-left">
                    a function to update <code>stories</code>
                  </td>
                </tr>

                <tr>
                  <td class="org-center">2</td>
                  <td class="org-left">all attributes in a story</td>
                </tr>

                <tr>
                  <td class="org-center">3</td>
                  <td class="org-left">
                    the attributes used to display a story
                  </td>
                </tr>

                <tr>
                  <td class="org-center">4</td>
                  <td class="org-left">
                    a story id; a list of comments under the story; a function
                    to update <code>comments</code>
                  </td>
                </tr>

                <tr>
                  <td class="org-center">5</td>
                  <td class="org-left">all attributes in a comment</td>
                </tr>

                <tr>
                  <td class="org-center">6</td>
                  <td class="org-left">
                    a comment id; the function to update <code>comments</code>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="outline-container-org21edeeb" class="outline-3">
          <h3 id="org21edeeb">
            <span class="section-number-3">3.4.</span> Why passing down the
            update function in props 1, 4, 6?
          </h3>
          <div class="outline-text-3" id="text-3-4">
            <ul class="org-ul">
              <li>
                To share the parent states, i.e., <code>stories</code> and
                <code>comments</code> to child component. Since the post action
                happens in the child component, we need a way to automatically
                update the states to see new contents immediately.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-web.html"
          >web</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-react.html"
          >react</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-mit.html"
          >mit</a
        >
      </div>

      <div class="post-date">23 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-23-weblab-notes:-react-hooks.html"
          >Weblab notes: React hooks</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org61185e5">1. What is a React hook</a>
              <ul>
                <li>
                  <a href="#org346138b"
                    >1.1. <code>useState</code> is not enough</a
                  >
                </li>
                <li>
                  <a href="#org063c869"
                    >1.2. <code>useEffect</code> runs after specific variable
                    change</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org76b0333">2. React hook patterns</a>
              <ul>
                <li><a href="#org274b414">2.1. Fetch and send data</a></li>
                <li><a href="#org3e7ef87">2.2. Conditional rendering</a></li>
                <li><a href="#org28b29e0">2.3. Render an array of Data</a></li>
              </ul>
            </li>
            <li><a href="#org6c40374">3. Example: Stopwatch</a></li>
            <li><a href="#org8ac8ae3">4. DOM and component mounting</a></li>
          </ul>
        </div>
      </nav>
      <div id="outline-container-org61185e5" class="outline-2">
        <h2 id="org61185e5">
          <span class="section-number-2">1.</span> What is a React hook
        </h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Special functions to access parts of the component lifestyle.
            </li>
            <li>e.g., <code>useState</code></li>
          </ul>
        </div>
        <div id="outline-container-org346138b" class="outline-3">
          <h3 id="org346138b">
            <span class="section-number-3">1.1.</span> <code>useState</code> is
            not enough
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #51afef;">const</span> [<span style="color: #dcaeea;">persons</span>, <span style="color: #dcaeea;">setPersons</span>] = useState([]);
<span class="linenr">2: </span>
<span class="linenr">3: </span>testingStuff = () =&gt; {
<span class="linenr">4: </span>    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">assume persons is empty before</span><span style="color: #5B6268;"> */</span>
<span class="linenr">5: </span>    setPersons([...persons, <span style="color: #98be65;">"me"</span>]);
<span class="linenr">6: </span>}
<span class="linenr">7: </span>console.log(persons);
</pre>
            </div>

            <ul class="org-ul">
              <li>
                The output of <code class="src src-js">console.log</code> is
                <code>[]</code> instead of <code>["me"]</code> because setting a
                state is <b><b>async</b></b
                >!
              </li>
              <li>
                To do something immediately after a state is changed, use
                <code>useEffect</code> hook!
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org063c869" class="outline-3">
          <h3 id="org063c869">
            <span class="section-number-3">1.2.</span>
            <code>useEffect</code> runs after specific variable change
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span>useEffect(() =&gt; {
<span class="linenr">2: </span>    console.log(persons);
<span class="linenr">3: </span>}, [persons]);
</pre>
            </div>

            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span>useEffect(() =&gt; {
<span class="linenr">2: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">do something, e.g., interact with an external service</span><span style="color: #5B6268;"> */</span>
<span class="linenr">3: </span>
<span class="linenr">4: </span><span style="color: #51afef;">return</span> () =&gt; {
<span class="linenr">5: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">cleanup function on dismount, e.g., disconnect from external service</span><span style="color: #5B6268;"> */</span>
<span class="linenr">6: </span>}
<span class="linenr">7: </span>}, [<span style="color: #5B6268;">/*</span><span style="color: #5B6268;">dependencies</span><span style="color: #5B6268;"> */</span>])
</pre>
            </div>

            <ul class="org-ul">
              <li>
                <code class="src src-js"
                  >useEffect(myFunction, [var1, var2])</code
                >
                calls <code>myFunction</code> everytime when
                <code>var1</code> or <code>var2</code> changes
              </li>
              <li>
                <code class="src src-js">useEffect(myFunction, []])</code> calls
                only once when the component is rendered for the first time (on
                mount)
              </li>
              <li>
                <code class="src src-js">useEffect(myFunction)</code> calls at
                every render
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org76b0333" class="outline-2">
        <h2 id="org76b0333">
          <span class="section-number-2">2.</span> React hook patterns
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org274b414" class="outline-3">
          <h3 id="org274b414">
            <span class="section-number-3">2.1.</span> Fetch and send data
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">fetch data on mount</span><span style="color: #5B6268;"> */</span>
<span class="linenr">2: </span>useEffect(() =&gt; {
<span class="linenr">3: </span>    get(<span style="color: #98be65;">"/api/packages"</span>).then((packageList) =&gt; {
<span class="linenr">4: </span>        setPackages(packageList);
<span class="linenr">5: </span>    });
<span class="linenr">6: </span>}, []);
</pre>
            </div>

            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">send data then toggle admin state</span><span style="color: #5B6268;"> */</span>
<span class="linenr">2: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">handleToggleAdmin</span> = () =&gt; {
<span class="linenr">3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.then(), do something once the promise is fulfilled</span>
<span class="linenr">4: </span>    post(<span style="color: #98be65;">"/api/user/admin"</span>, { admin: !admin }).then(() =&gt; {
<span class="linenr">5: </span>        setAdmin(!admin);
<span class="linenr">6: </span>    });
<span class="linenr">7: </span>};
<span class="linenr">8: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">&lt;Button onClick={handleToggleAdmin}</span><span style="color: #5B6268;"> */</span>
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org3e7ef87" class="outline-3">
          <h3 id="org3e7ef87">
            <span class="section-number-3">2.2.</span> Conditional rendering
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">JSX is a way of writing HTML in js</span>
<span class="linenr">2: </span><span style="color: #51afef;">let</span> <span style="color: #dcaeea;">content</span> = loading ? &lt;p&gt;Loading...&lt;/p&gt; : &lt;p&gt;Loaded&lt;/p&gt;;
<span class="linenr">3: </span><span style="color: #51afef;">return</span> (
<span class="linenr">4: </span>    &lt;div&gt;
<span class="linenr">5: </span>        &lt;h1&gt;Title&lt;/h1&gt;
<span class="linenr">6: </span>        {content}
<span class="linenr">7: </span>    &lt;/div&gt;
<span class="linenr">8: </span>);
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org28b29e0" class="outline-3">
          <h3 id="org28b29e0">
            <span class="section-number-3">2.3.</span> Render an array of Data
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">data</span> = [
<span class="linenr">2: </span>    { id: <span style="color: #da8548; font-weight: bold;">0</span>, text: <span style="color: #98be65;">"Text 1"</span> },
<span class="linenr">3: </span>    { id: <span style="color: #da8548; font-weight: bold;">1</span>, text: <span style="color: #98be65;">"Text 2"</span> },
<span class="linenr">4: </span>];
<span class="linenr">5: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">render a component for each data item</span>
<span class="linenr">6: </span><span style="color: #51afef;">return</span> data.map((item) =&gt; (
<span class="linenr">7: </span>    &lt;ItemComponent key={item.id}&gt;{item.text}&lt;/ItemComponent&gt;
<span class="linenr">8: </span>));
</pre>
            </div>
            <ul class="org-ul">
              <li>
                <code>key</code> is a special prop in React; it is used identify
                which item has changed efficiently
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org6c40374" class="outline-2">
        <h2 id="org6c40374">
          <span class="section-number-2">3.</span> Example: Stopwatch
        </h2>
        <div class="outline-text-2" id="text-3">
          <div class="org-src-container">
            <pre
              class="src src-js"
            ><span class="linenr"> 1: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">Stopwatch</span> = () =&gt; {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">const</span> [<span style="color: #dcaeea;">time</span>, <span style="color: #dcaeea;">setTimer</span>] = useState(<span style="color: #da8548; font-weight: bold;">0</span>);
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>    useEffect(() =&gt; {
<span class="linenr"> 5: </span>        <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">timer</span> = setInterval(() =&gt; {
<span class="linenr"> 6: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setTimer accepts either a new state value,</span>
<span class="linenr"> 7: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or a function that takes the previous state (oldTime) as an argument and returns the new state</span>
<span class="linenr"> 8: </span>            setTime((oldTime) =&gt; oldTime + <span style="color: #da8548; font-weight: bold;">1</span>);}, <span style="color: #da8548; font-weight: bold;">1000</span>);
<span class="linenr"> 9: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if not properly cleanup after unmounting</span>
<span class="linenr">10: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the timer will continue to run even the state no longer exists</span>
<span class="linenr">11: </span>        <span style="color: #51afef;">return</span> () =&gt; clearInterval(timer);
<span class="linenr">12: </span>    }, []);
<span class="linenr">13: </span>    <span style="color: #51afef;">return</span> &lt;&gt;TIme: {time}&lt;/&gt;;
<span class="linenr">14: </span>};
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org8ac8ae3" class="outline-2">
        <h2 id="org8ac8ae3">
          <span class="section-number-2">4.</span> DOM and component mounting
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              DOM (Document Object Model): a programming interface for web
              documents; represents the structure of a document, e.g., HTML, as
              a tree of objects, where each object corresponds to a part of the
              document; it dynamically updates the document contents
              <ul class="org-ul">
                <li>React is a framework that manipulates DOM</li>
              </ul>
            </li>
            <li>
              A React component is unmounted when:
              <ul class="org-ul">
                <li>conditional rendering</li>
                <li>routing; navigating from one route to another</li>
                <li>its parent component is unmounted</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-web.html"
          >web</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-react.html"
          >react</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-mit.html"
          >mit</a
        >
      </div>
      <div id="archive">
        <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
          >Other posts</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <div id="search-results"></div>
      <footer>
        <p> 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
